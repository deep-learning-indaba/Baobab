version: "3.2"
services:
  redis:
    image: redis
    ports:
      - 6379:6379
  db:
    image: postgres
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: docker
      POSTGRES_PASSWORD: docker
      POSTGRES_DB: docker
  storage:
    image: fsouza/fake-gcs-server
    ports:
      - 4443:4443
  web:
    build: ./api
    command: python ./api/run.py runserver -h 0.0.0.0 -p 5000
    volumes:
      - .:/code
      - ~/.config/gcloud:/root/.config/gcloud
    ports:
      - 5000:5000
    links:
      - db
      - storage
      - redis
    environment:
      DEBUG: "True"
      SECRET_KEY: __filler__
      SMTP_USERNAME: __filler__
      SMTP_PASSWORD: __filler__
      SMTP_SENDER_NAME: __filler__
      SMTP_SENDER_EMAIL: __filler__
      SMTP_HOST: __filler__
      SMTP_PORT: 587
      GCP_CLIENT_ID: 114966260410024802375
      GCP_CLIENT_EMAIL: 'baobab-service@baobab.iam.gserviceaccount.com'
      GCP_PRIVATE_KEY_ID: '0303be1949631be62aab02f8cfef08f0c9723aac'
      GCP_PRIVATE_KEY: '-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDCMidA81xRs7B3\nNcVC1MOeYdgM7Wzp7to+w8/KCW8bef27j8CriEhTk0wfKQ5Sz4VB04wliOl1pjZx\nbSYYXHQWpjpIxTLNGnF/KuhRdI6ZV4yQ2Va6ga27oPZlFOsmRcFOV+ZUEBAKU0Ad\n9KrhMNUb9O8wC+b59LvaFS215nAiqGvhZp6dXZ1NJuseQe/yGcrL3IoSN3AwA5dm\neqCibds3NiyXQB8Icl35l4YbKuVQKDmQvGSeunJRjnjXN4o3VXdW7daTEnvmqXuE\nmnnmL/Q+U5qKUvmWyASMCyNzPekVj3DMU1zUQj+QFvYZ3iGJH2O5N7zkPlvoC1V8\n3hoBOe8NAgMBAAECggEADa4xGbuvv9LazQ+s9Gt11rrOawGUlKLg+RXS3v/s2mwa\nfwGHg8TcCBc3gC3kiLYQsgfikiyj1bWjAxRNFwP3xjZpWd1RYyWRdnFh8qsQ0crt\nZ9W+o8xcC/yenwM0PsP7z6Q5BfFM4kQvH0iLxKDineHbshTNtsNI6bD6iokZCTfh\n6+Tt/N4MK6UwBfVXL3Ca2hVVLthZVJwLjovqZgElv/xItBi21qOJqN5GMVxX4Myy\npBMvSCJV9MdL9yxdWh/mV3Ie5977fpC69UsQoSktJAroTFzUbe73iYAGNlYekmUl\nfAJSwiAft+19tsaBSmiRr3X/bvGms+eBbKzwzFUgOQKBgQDgT/6RhswfACKfBBXn\n4B59HeG86oCR094KmiNjk8RowJbn1lJIWG+aEFKt90HxUJeQvmprepLaSpb/uZPh\nBX3q4AHw0uGRw9B5MifWopQwKEPUtAH8SACKcF+7Y0Ar14ib6kVORbOEhmesaIvG\nAiitddRUAhWVseMPAwVJq1RgCwKBgQDdoQcNu612GHiNc+BN1E1mNpiB3IUQ0Bnx\nqqxCu7xED6C0Jz2uSw6VR6WRVBLFrLVNel84uTkEAv/8oWpQOjd3JSHioVYBaweg\n45SLjRTJU2rNFgUnnNJLjXWW45Dp7/RNbauVnxyT52HCJQ4q3x6ZLLQYBK72659S\nZTcrbE1kRwKBgBHTSY+W/rGX+ShZ0sPSc5nNvhqdKApuo76D8TwAiiMo6tURmwhU\nvsmncmqQs5TRqrm96AcSfokKVGWOAcpn/VGk64KPv40t2mtHKRNNaClLidhlVaMO\ntbxKodDqWjchsaFyRH+r2lA1vhddV34svb7LFkx2vfBfaoPO4aSxEMtxAoGBAMHk\nWZ5rHcMef4EI6ihM3vXYN64MtaFS3g+tyAyN35QPtAFH/09XPMfeqXut+MpVYTwK\nHforGTVoRnnG4ZKUi+fBZZa2nN6au07HKzK3V4MWZm5LoHDaYqRUepZqOmJfWfTP\nSHiafc7rc3v9HRrmngdVs6z7k/JTisvz3sMvebmLAoGAH5pgwpso1hmU5I0erfdY\nVcYvQpkmNnrroJlhFNBbYMh9ODm1MjHS3O9hLVE8zPeMoYuBMxFl9kuepFN4kD9Q\n11Ha/W4DucO6UZPHZIK3QuNRcs1kfmA5kGeLg8YHMlMnZIW8k9ZnDLN14x1+F4KS\n0Jg4WMsFMCKROMwwzUVZBfA=\n-----END PRIVATE KEY-----\n'
      GCP_PROJECT_NAME: 'baobab'
      GCP_BUCKET_NAME: 'fileuploads-deeplearningindaba'
      GCP_API_KEY: AIzaSyCCYANP8yh0W5fahjy8t50gFdjr8EwnhSg
      FILE_SIZE_LIMIT: 52428800
      BOABAB_HOST: http://localhost:8080

  webapp:
    build: ./webapp
    command: yarn start
    volumes:
      - ./webapp:/usr/src/app
      - ./webapp:/webapp
    ports:
      - "8080:3000"
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
    links:
      - web

  test-ci:
    build:
      context: ./webapp
      dockerfile: Dockerfile-test
    command: yarn test-ci

  webappintegration:
    build: ./webapp
    command: yarn start-integration
    volumes:
      - ./webapp:/usr/src/app
      - ./webapp:/webapp
    ports:
      - "8081:3000"
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true

  cypress:
    ipc: host
    image: "cypress/included:4.2.0"
    links:
      - webappintegration
      - web
    environment:
      # pass base url to test pointing at the web application
      - CYPRESS_baseUrl=http://webappintegration:3000
    # share the current folder as volume to avoid copying
    working_dir: /integration-tests
    volumes:
      - ./integration-tests/:/integration-tests
